<?php

namespace Fsb\AppointmentBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query\ResultSetMapping;
/**
 * AppointmentRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AppointmentRepository extends EntityRepository
{
	/**
	 * Get The appointments of a recruiter and in a particular month
	 *
	 * @param int $recruiter_id
	 * @param int $month
	 * @param int $year
	 * 
	 * @return array Appointments
	 */
	public function findNumAppointmentsByRecruiterAndByMonth($recruiter_id,$month,$year, $projects = null, $outcomes = null) {
	
		$em = $this->getEntityManager();
		
		$query = $em->createQueryBuilder()
		->select(array('SUBSTRING(a.startDate, 9, 2) AS day', 'COUNT(a.id) AS numapp'))
		->from('AppointmentBundle:Appointment', 'a')
		->innerJoin('a.appointmentDetail', 'ad')
		->where('a.recruiter = :recruiter_id')
		->andWhere('SUBSTRING(a.startDate, 6, 2) = :month')
		->andWhere('SUBSTRING(a.startDate, 1, 4) = :year')
		->groupBy('day')
		->orderBy('a.startDate', 'ASC')
		
		->setParameter('recruiter_id', $recruiter_id)
		->setParameter('month', (int)$month)
		->setParameter('year', (int)$year)
		;
		
		if (count($projects) > 0) {
			$query
			->andWhere('ad.project IN (:projects)')
			->setParameter('projects', $projects);
		}
		
		if (count($outcomes) > 0) {
			$query
			->andWhere('ad.outcome IN (:outcomes)')
			->setParameter('outcomes', $outcomes);
		}
		
		$recruiter_ar = $query->getQuery()->getResult();
	
		return $recruiter_ar;
	}
	
	/**
	 * Get The appointments of a recruiter and in a particular day
	 *
	 * @param int $recruiter_id
	 * @param $day
	 * @param int $month
	 * @param int $year
	 *
	 * @return array Appointments
	 */
	public function findAppointmentsByRecruiterAndByDay($recruiter_id,$day,$month,$year, $projects = null, $outcomes = null) {
	
		$em = $this->getEntityManager();
	
		$query = $em->createQueryBuilder()
		->select(array(
				'SUBSTRING(a.startDate, 11, 3) AS hour', 
				'SUBSTRING(a.startDate, 15, 2) AS minute',
				'a.id, ad.title', 
				'ad.comment',
				'ud.firstname as recruiter',
				'p.name as project',
				'o.name as outcome',
				'ad.outcomeReason'
		))
		->from('AppointmentBundle:Appointment', 'a')
		->innerJoin('a.appointmentDetail', 'ad')
		->innerJoin('ad.project', 'p')
		->innerJoin('ad.outcome', 'o')
		->innerJoin('a.recruiter', 'u')
		->innerJoin('u.userDetail', 'ud')
		->where('a.recruiter = :recruiter_id')
		->andWhere('SUBSTRING(a.startDate, 9, 2) = :day')
		->andWhere('SUBSTRING(a.startDate, 6, 2) = :month')
		->andWhere('SUBSTRING(a.startDate, 1, 4) = :year')
		->orderBy('a.startDate', 'ASC')
		
		->setParameter('recruiter_id', $recruiter_id)
		->setParameter('day', (int)$day)
		->setParameter('month', (int)$month)
		->setParameter('year', (int)$year)
		;
		
		if (count($projects) > 0) {
			$query
			->andWhere('ad.project IN (:projects)')
			->setParameter('projects', $projects);
		}
		
		if (count($outcomes) > 0) {
			$query
			->andWhere('ad.outcome IN (:outcomes)')
			->setParameter('outcomes', $outcomes);
		}
		
		$recruiter_ar = $query->getQuery()->getResult();
	
		return $recruiter_ar;
	}
	
	/**
	 * Get The appointments of a recruiter and since a particular day
	 *
	 * @param int $recruiter_id
	 * @param $day
	 * @param int $month
	 * @param int $year
	 *
	 * @return array Appointments
	 */
	public function findAppointmentsByRecruiterFromDay($recruiter_id,$day,$month,$year, $projects = null, $outcomes = null) {
	
		$em = $this->getEntityManager();
	
		$dql = 'SELECT
					a.startDate as date, a.id, ad.title, ad.comment,
					ud.firstname as recruiter,
					p.name as project,
					o.name as outcome,
					ad.outcomeReason
					FROM AppointmentBundle:Appointment a
					JOIN a.appointmentDetail ad
					JOIN ad.project p
					JOIN ad.outcome o
					JOIN a.recruiter u
					JOIN u.userDetail ud
					WHERE
						a.recruiter = :recruiter_id AND
						a.startDate > :date
					ORDER BY a.startDate ASC';
	
		$query = $em->createQuery($dql);
		$query->setParameter('recruiter_id', $recruiter_id);
		$query->setParameter('date', new \DateTime($year.'-'.$month.'-'.$day.' 00:00:00'));
	
		
		
		
		$query = $em->createQueryBuilder()
		->select(array(
				'a.startDate as date, a.id, ad.title, ad.comment',
				'ud.firstname as recruiter',
				'p.name as project',
				'o.name as outcome',
				'ad.outcomeReason'
		))
		->from('AppointmentBundle:Appointment', 'a')
		->innerJoin('a.appointmentDetail', 'ad')
		->innerJoin('ad.project', 'p')
		->innerJoin('ad.outcome', 'o')
		->innerJoin('a.recruiter', 'u')
		->innerJoin('u.userDetail', 'ud')
		->where('a.recruiter = :recruiter_id')
		->andWhere('a.recruiter = :recruiter_id')
		->andWhere('a.startDate > :date')
		->orderBy('a.startDate', 'ASC')
		
		->setParameter('recruiter_id', $recruiter_id)
		->setParameter('date', new \DateTime($year.'-'.$month.'-'.$day.' 00:00:00'))
		;
		
		if (count($projects) > 0) {
			$query
			->andWhere('ad.project IN (:projects)')
			->setParameter('projects', $projects);
		}
		
		if (count($outcomes) > 0) {
			$query
			->andWhere('ad.outcome IN (:outcomes)')
			->setParameter('outcomes', $outcomes);
		}
		
		$recruiter_ar = $query->getQuery()->getResult();
	
		return $recruiter_ar;
	}
}
